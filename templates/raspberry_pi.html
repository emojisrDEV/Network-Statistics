{% extends "base.html" %}

{% block title %}Raspberry Pi Setup - NetMonitor Pro{% endblock %}

{% block content %}
<!-- Header -->
<header class="bg-surface shadow-sm border-b border-border px-6 py-4">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold">Raspberry Pi Setup</h2>
            <p class="text-sm text-muted-foreground">Configure Raspberry Pi nodes for distributed network monitoring</p>
        </div>
        <div class="flex items-center space-x-4">
            <button onclick="refreshNodes()" class="btn btn-outline">
                <i data-lucide="rotate-ccw" class="h-4 w-4"></i>
            </button>
            <a href="/" class="btn btn-outline">
                <i data-lucide="arrow-left" class="h-4 w-4 mr-2"></i>
                Back to Dashboard
            </a>
        </div>
    </div>
</header>

<div class="p-6 space-y-6">
    <!-- Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-muted-foreground">Connected Nodes</p>
                    <p id="connected-nodes" class="text-2xl font-bold text-success">0</p>
                </div>
                <div class="w-12 h-12 bg-success/20 rounded-full flex items-center justify-center">
                    <i data-lucide="cpu" class="h-6 w-6 text-success"></i>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-muted-foreground">Active Monitors</p>
                    <p id="active-monitors" class="text-2xl font-bold text-primary">0</p>
                </div>
                <div class="w-12 h-12 bg-primary/20 rounded-full flex items-center justify-center">
                    <i data-lucide="activity" class="h-6 w-6 text-primary"></i>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-muted-foreground">Last Heartbeat</p>
                    <p id="last-heartbeat" class="text-lg font-bold">Never</p>
                </div>
                <div class="w-12 h-12 bg-warning/20 rounded-full flex items-center justify-center">
                    <i data-lucide="heart-pulse" class="h-6 w-6 text-warning"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Setup -->
    <div class="card p-6">
        <h3 class="text-lg font-semibold mb-4">Quick Installation</h3>
        <div class="bg-muted/50 p-4 rounded border">
            <p class="text-sm text-muted-foreground mb-3">Run this command on your Raspberry Pi to automatically install and configure the monitoring agent:</p>
            <div class="flex items-center space-x-2">
                <code id="install-command" class="flex-1 bg-background p-3 rounded text-sm font-mono">curl -sSL {{ request.host_url }}install.sh | bash</code>
                <button onclick="copyInstallCommand()" class="btn btn-outline">
                    <i data-lucide="copy" class="h-4 w-4"></i>
                </button>
            </div>
        </div>
        <div class="mt-4 p-4 bg-primary/10 border border-primary rounded">
            <div class="flex items-start space-x-2">
                <i data-lucide="info" class="h-4 w-4 text-primary mt-0.5 flex-shrink-0"></i>
                <div class="text-sm">
                    <strong>Note:</strong> The installation script will automatically detect your server URL and configure the monitoring agent to report back to this dashboard.
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Setup Steps -->
    <div class="card p-6">
        <h3 class="text-lg font-semibold mb-4">Manual Installation Steps</h3>
        <div class="space-y-4">
            <div class="border-l-4 border-primary pl-4">
                <h4 class="font-semibold">1. Prepare Your Raspberry Pi</h4>
                <p class="text-sm text-muted-foreground mt-1">Ensure your Raspberry Pi is running a recent version of Raspberry Pi OS and has internet connectivity.</p>
                <div class="mt-2 bg-muted p-3 rounded text-sm">
                    <code>sudo apt update && sudo apt upgrade -y</code>
                </div>
            </div>

            <div class="border-l-4 border-primary pl-4">
                <h4 class="font-semibold">2. Install Python Dependencies</h4>
                <p class="text-sm text-muted-foreground mt-1">Install required Python packages for system monitoring and network communication.</p>
                <div class="mt-2 bg-muted p-3 rounded text-sm">
                    <code>sudo apt install -y python3 python3-pip<br>sudo pip3 install requests psutil</code>
                </div>
            </div>

            <div class="border-l-4 border-primary pl-4">
                <h4 class="font-semibold">3. Download Monitoring Script</h4>
                <p class="text-sm text-muted-foreground mt-1">Download the monitoring agent from this server.</p>
                <div class="mt-2 bg-muted p-3 rounded text-sm">
                    <code>wget {{ request.host_url }}monitor.py -O /opt/netmonitor/monitor.py</code>
                </div>
            </div>

            <div class="border-l-4 border-primary pl-4">
                <h4 class="font-semibold">4. Configure Systemd Service</h4>
                <p class="text-sm text-muted-foreground mt-1">Set up the monitoring agent to run automatically at boot.</p>
                <div class="mt-2 bg-muted p-3 rounded text-sm">
                    <code>sudo systemctl enable netmonitor<br>sudo systemctl start netmonitor</code>
                </div>
            </div>
        </div>
    </div>

    <!-- Connected Nodes -->
    <div class="card">
        <div class="px-6 py-4 border-b border-border">
            <h3 class="text-lg font-semibold">Connected Raspberry Pi Nodes</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-muted/50">
                    <tr class="border-b border-border">
                        <th class="text-left p-4 font-medium">Node Name</th>
                        <th class="text-left p-4 font-medium">IP Address</th>
                        <th class="text-left p-4 font-medium">Status</th>
                        <th class="text-left p-4 font-medium">CPU Usage</th>
                        <th class="text-left p-4 font-medium">Memory Usage</th>
                        <th class="text-left p-4 font-medium">Last Heartbeat</th>
                        <th class="text-left p-4 font-medium">Actions</th>
                    </tr>
                </thead>
                <tbody id="nodes-list">
                    <tr>
                        <td colspan="7" class="p-4 text-center text-muted-foreground">Loading nodes...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Configuration -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Add New Node -->
        <div class="card p-6">
            <h3 class="text-lg font-semibold mb-4">Register New Node</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Node Name</label>
                    <input type="text" id="node-name" placeholder="pi-monitor-01" 
                           class="w-full p-2 border border-border rounded bg-background">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">IP Address</label>
                    <input type="text" id="node-ip" placeholder="192.168.1.100" 
                           class="w-full p-2 border border-border rounded bg-background">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Location (Optional)</label>
                    <input type="text" id="node-location" placeholder="Living Room" 
                           class="w-full p-2 border border-border rounded bg-background">
                </div>
                <button onclick="registerNode()" class="btn btn-primary w-full">
                    <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                    Register Node
                </button>
            </div>
        </div>

        <!-- Monitoring Configuration -->
        <div class="card p-6">
            <h3 class="text-lg font-semibold mb-4">Monitoring Settings</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm">Heartbeat Interval</span>
                    <select class="p-2 border border-border rounded bg-background">
                        <option value="30">30 seconds</option>
                        <option value="60" selected>1 minute</option>
                        <option value="300">5 minutes</option>
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm">Auto-Discovery</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-muted peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm">Alert Notifications</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-muted peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
                <button class="btn btn-outline w-full">
                    <i data-lucide="save" class="h-4 w-4 mr-2"></i>
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Fallback Notice -->
    <div class="card p-6 bg-warning/10 border-warning">
        <div class="flex items-start space-x-3">
            <i data-lucide="alert-triangle" class="h-5 w-5 text-warning mt-0.5 flex-shrink-0"></i>
            <div>
                <h4 class="font-semibold text-warning">Host-Based Monitoring Active</h4>
                <p class="text-sm text-muted-foreground mt-1">
                    When Raspberry Pi nodes are not available, the system automatically uses host-based monitoring 
                    to collect network statistics and device information from the server itself. This ensures 
                    continuous monitoring even without dedicated Pi nodes.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function refreshNodes() {
        loadRaspberryPiNodes();
        loadNodeStats();
    }

    function loadRaspberryPiNodes() {
        fetch('/api/raspberry-pi')
            .then(response => response.json())
            .then(nodes => {
                const tbody = document.getElementById('nodes-list');
                document.getElementById('connected-nodes').textContent = nodes.length;
                
                if (nodes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-muted-foreground">No nodes connected. Use the installation command above to set up your first Raspberry Pi node.</td></tr>';
                    return;
                }

                tbody.innerHTML = nodes.map(node => {
                    const statusBadge = node.isOnline ? 
                        '<span class="badge badge-success">Online</span>' : 
                        '<span class="badge badge-destructive">Offline</span>';
                    
                    const cpuUsage = node.systemStats?.cpuUsage ? node.systemStats.cpuUsage + '%' : 'N/A';
                    const memoryUsage = node.systemStats?.memoryUsage ? node.systemStats.memoryUsage + '%' : 'N/A';
                    const lastHeartbeat = node.lastHeartbeat ? 
                        new Date(node.lastHeartbeat).toLocaleString() : 'Never';
                    
                    return `
                        <tr class="border-b border-border hover:bg-muted/50">
                            <td class="p-4 font-medium">${node.name}</td>
                            <td class="p-4">${node.ipAddress}</td>
                            <td class="p-4">${statusBadge}</td>
                            <td class="p-4">${cpuUsage}</td>
                            <td class="p-4">${memoryUsage}</td>
                            <td class="p-4 text-sm text-muted-foreground">${lastHeartbeat}</td>
                            <td class="p-4">
                                <button onclick="removeNode('${node.id}')" class="text-destructive hover:text-destructive/80">
                                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                lucide.createIcons();
            })
            .catch(error => {
                console.log('Raspberry Pi service not available');
                document.getElementById('nodes-list').innerHTML = 
                    '<tr><td colspan="7" class="p-4 text-center text-muted-foreground">Raspberry Pi monitoring service not available. Using host-based monitoring instead.</td></tr>';
            });
    }

    function loadNodeStats() {
        fetch('/api/raspberry-pi')
            .then(response => response.json())
            .then(nodes => {
                const activeNodes = nodes.filter(node => node.isOnline).length;
                document.getElementById('active-monitors').textContent = activeNodes;
                
                if (nodes.length > 0) {
                    const lastHeartbeat = Math.max(...nodes.map(node => 
                        node.lastHeartbeat ? new Date(node.lastHeartbeat).getTime() : 0
                    ));
                    
                    if (lastHeartbeat > 0) {
                        document.getElementById('last-heartbeat').textContent = 
                            new Date(lastHeartbeat).toLocaleString();
                    }
                }
            })
            .catch(error => console.log('Could not load node stats'));
    }

    function copyInstallCommand() {
        const command = document.getElementById('install-command').textContent;
        navigator.clipboard.writeText(command).then(() => {
            // Visual feedback
            const button = event.target.closest('button');
            const icon = button.querySelector('i');
            icon.setAttribute('data-lucide', 'check');
            lucide.createIcons();
            
            setTimeout(() => {
                icon.setAttribute('data-lucide', 'copy');
                lucide.createIcons();
            }, 2000);
        });
    }

    function registerNode() {
        const name = document.getElementById('node-name').value;
        const ip = document.getElementById('node-ip').value;
        const location = document.getElementById('node-location').value;

        if (!name || !ip) {
            alert('Please enter both node name and IP address');
            return;
        }

        fetch('/api/raspberry-pi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, ipAddress: ip, location })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                document.getElementById('node-name').value = '';
                document.getElementById('node-ip').value = '';
                document.getElementById('node-location').value = '';
                refreshNodes();
            } else {
                alert('Error registering node: ' + result.error);
            }
        })
        .catch(error => {
            alert('Error registering node: ' + error.message);
        });
    }

    function removeNode(nodeId) {
        if (!confirm('Are you sure you want to remove this node?')) {
            return;
        }

        fetch(`/api/raspberry-pi/${nodeId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    refreshNodes();
                } else {
                    alert('Error removing node: ' + result.error);
                }
            })
            .catch(error => {
                alert('Error removing node: ' + error.message);
            });
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        refreshNodes();
    });
</script>
{% endblock %}